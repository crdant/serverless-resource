#!/bin/sh
set -e

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging

destination=$1

if [ -z "$destination" ]; then
  echo "usage: $0 <path/to/destination>" >&2
  exit 1
fi

. $(dirname $0)/common.sh

export PATH=/usr/local/bin:${PATH}

store_payload

# determine command
deploy=$(extract_config "deploy")
echo "Deploy: ${deploy}"

if [ -z "$deploy" ]; then
  deploy=false
fi

if [ "${deploy}" = "true" ] ; then
  cmd="deploy"
else
  cmd="package"
fi

echo "Command: ${cmd}"

# setup flags
flags=

package=$(extract_config "package")
if [ -n "${package}" ] ; then
  flags="${flags} --package ${package}"
fi

stage=$(extract_parameter "stage")
if [ -n "${stage}" ] && [ "${stage}" != "null" ] ; then
  flags="${flags} --stage ${stage}"
else
  stage=$(extract_config "stage")
  if [ -n "${stage}" ] ; then
    flags="${flags} --stage ${stage}"
  fi
fi

echo "$flags"
serverless_cmd info # $cmd $flags

jq -n "{
  metadata: [
    \"package\": \"${package}\"
  ]
}" >&3
